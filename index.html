<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Web de juegos para ni√±os</title>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

    <style>
        /* --- ESTILOS VISUALES --- */
        :root {
            --sky: #e0f7fa; --cloud: #ffffff; --text: #37474f;
            --btn-green: #66bb6a; --btn-blue: #42a5f5; --btn-purple: #ab47bc; --btn-red: #ef5350;
            --stone: #90a4ae; --gold: #ffd700;
        }
        * { box-sizing: border-box; }
        body { 
            font-family: 'Press Start 2P', cursive; background-color: var(--sky);
            background-image: radial-gradient(#b2ebf2 15%, transparent 16%), radial-gradient(#b2ebf2 15%, transparent 16%);
            background-size: 30px 30px; color: var(--text); margin: 0; padding: 20px; 
            user-select: none; line-height: 1.5;
        }

        .app-container { max-width: 1400px; margin: 0 auto; display: grid; grid-template-columns: 280px 1fr 320px; gap: 20px; }
        header { grid-column: 1 / -1; display: flex; justify-content: space-between; align-items: center; }
        .panel { background: var(--cloud); border: 4px solid #37474f; padding: 20px; margin-bottom: 20px; box-shadow: 6px 6px 0px rgba(0,0,0,0.1); }

        /* BOTONES */
        .mc-btn { 
            color: #fff; border: 4px solid; padding: 15px; font-family: 'Press Start 2P', cursive; font-size: 0.7rem; 
            cursor: pointer; text-transform: uppercase; box-shadow: inset -4px -4px 0px 0px rgba(0,0,0,0.2); 
            position: relative; transition: transform 0.1s; 
        }
        .mc-btn:active { transform: translateY(4px); box-shadow: inset -2px -2px 0px 0px rgba(0,0,0,0.2); }
        .mc-btn.green { background-color: var(--btn-green); border-color: #2e7d32; }
        .mc-btn.blue { background-color: var(--btn-blue); border-color: #1565c0; }
        .mc-btn.purple { background-color: var(--btn-purple); border-color: #7b1fa2; }
        .mc-btn.red { background-color: var(--btn-red); border-color: #c62828; }
        .mc-btn.gray { background-color: var(--stone); border-color: #546e7a; }

        /* AVATAR */
        .avatar-container { display: flex; flex-direction: column; align-items: center; gap: 2px; transform: scale(1.8); margin: 40px 0; }
        .mc-part { border: 2px solid #000; background-size: cover !important; background-position: center !important; image-rendering: pixelated; position: relative; }
        .mc-head { width: 40px; height: 40px; background: #ffcc80; z-index: 5; }
        .mc-eyes { display: flex; gap: 14px; position: absolute; top: 15px; left: 6px; pointer-events: none; }
        .eye { width: 6px; height: 6px; background: white; border: 1px solid black; }
        .pupil { width: 3px; height: 3px; background: black; margin-left: 2px; margin-top: 1px; }
        .mc-body-row { display: flex; gap: 2px; z-index: 4; }
        .mc-arm { width: 12px; height: 40px; background: #ffcc80; margin-top: 0; }
        .mc-torso { width: 40px; height: 40px; background: #29b6f6; }
        .mc-legs-row { display: flex; gap: 2px; z-index: 3; }
        .mc-leg { width: 18px; height: 40px; background: #3f51b5; }

        /* LEADERBOARD */
        .leaderboard-list { display: flex; flex-direction: column; gap: 10px; max-height: 600px; overflow-y: auto; }
        .leaderboard-row { display: flex; align-items: center; gap: 10px; background: #eceff1; padding: 8px; border: 2px solid #b0bec5; font-size: 0.6rem; }
        .leaderboard-row.top-1 { border-color: var(--gold); background: #fffde7; }
        .mini-avatar-box { transform: scale(0.5); width: 45px; height: 70px; margin: -20px -5px; } 

        /* NIVELES */
        .subject-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; }
        .level-grid { display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; }
        .level-block { width: 45px; height: 45px; background: #cfd8dc; border: 4px solid #90a4ae; display: flex; align-items: center; justify-content: center; cursor: pointer; color: #546e7a; font-weight: bold; font-size: 0.8rem; }
        .level-block.locked { opacity: 0.5; cursor: not-allowed; background: #eceff1; }
        .level-block.completed { background: var(--btn-green); border-color: #2e7d32; color: white; }
        .level-block.current { background: white; border-color: var(--btn-blue); color: var(--btn-blue); transform: scale(1.1); box-shadow: 0 4px 10px rgba(0,0,0,0.1); }

        /* UI */
        input, select { padding: 12px; margin: 5px 0; width: 100%; font-family: 'Press Start 2P'; border: 2px solid #90a4ae; background: #eceff1; color: #37474f; outline: none; }
        .stats-bar { display: flex; justify-content: space-around; background: #263238; color: #4caf50; padding: 10px; border: 2px solid #000; margin-bottom: 15px; font-size: 0.7rem; }
        #notification-area { position: fixed; top: 20px; right: 20px; z-index: 2000; display: flex; flex-direction: column; gap: 10px; }
        .toast { background: #333; color: #fff; padding: 15px 20px; border: 4px solid #fff; font-size: 0.7rem; display: flex; align-items: center; gap: 10px; box-shadow: 4px 4px 0px rgba(0,0,0,0.2); animation: slideIn 0.3s forwards, fadeOut 0.5s 3s forwards; min-width: 250px; }
        .toast.success { background: var(--btn-green); border-color: #1b5e20; } .toast.error { background: var(--btn-red); border-color: #b71c1c; }
        
        /* MODALS */
        .overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); backdrop-filter: blur(4px); z-index: 100; justify-content: center; align-items: center; }
        .modal-box { background: var(--cloud); padding: 20px; border: 4px solid #37474f; width: 95%; max-width: 600px; text-align: center; box-shadow: 0 10px 20px rgba(0,0,0,0.2); }

        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes fadeOut { to { opacity: 0; pointer-events: none; } }
        .admin-tag { font-size: 0.6rem; color: #90a4ae; margin-top: 15px; cursor: pointer; text-decoration: underline; }
    </style>
</head>
<body>

<div id="notification-area"></div>

<div class="app-container">
    <header class="panel">
        <div>
            <h1 style="margin:0; color:#0277bd; font-size:1.5rem;">Web de juegos para los chicos</h1>
        </div>
        <div style="text-align:right">
            <div style="color:#fbc02d; font-size:1.2rem; margin-bottom:5px;">ü™ô <span id="uiCoins">0</span></div>
            <select id="gradeSelect" onchange="changeGrade()" style="width:auto; font-size:0.6rem; padding:5px;">
                <option value="1">1¬∫ Grado</option>
                <option value="3">3¬∫ Grado</option>
                <option value="5">5¬∫ Grado</option>
                <option value="7">7¬∫ Grado</option>
            </select>
        </div>  
    </header>

    <aside>
        <div class="panel" style="text-align:center;">
            <h3 style="font-size:0.8rem;">Nombre</h3>
            <input type="text" id="usernameInput" placeholder="Nombre" maxlength="10" 
                   style="text-align:center; margin-bottom:15px; font-size:0.7rem;" 
                   onchange="updateUsername(this.value)">
            
            <div class="avatar-container">
                <div class="mc-head mc-part" id="avHead">
                    <div class="mc-eyes" id="defaultEyes"><div class="eye"><div class="pupil"></div></div><div class="eye"><div class="pupil"></div></div></div>
                </div>
                <div class="mc-body-row">
                    <div class="mc-arm mc-part" id="avArmL"></div>
                    <div class="mc-torso mc-part" id="avTorso"></div>
                    <div class="mc-arm mc-part" id="avArmR"></div>
                </div>
                <div class="mc-legs-row">
                    <div class="mc-leg mc-part" id="avLegL"></div>
                    <div class="mc-leg mc-part" id="avLegR"></div>
                </div>
            </div>
            
            <div style="display:flex; flex-direction:column; gap:10px; margin-top:20px;">
                <button class="mc-btn blue" onclick="showDashboard()"> üéÆJUEGOS</button>
                <button class="mc-btn green" onclick="showShop()">üõçÔ∏è Tienda</button>
            </div>
            <div style="margin-top: 30px; border-top: 2px dashed #90a4ae; padding-top: 10px;">
                <div class="admin-tag" onclick="openAdminLogin()">Administrador</div>
                <button class="mc-btn red" style="width:100%; margin-top:15px; font-size:0.6rem;" onclick="resetGame()">‚ö†Ô∏è Reiniciar</button>
            </div>
        </div>
    </aside>

    <main class="panel">
        <div id="view-dashboard">
            <h3 style="margin-top:0;">A que jugamos hoy??</h3>
            <div class="subject-grid">
                <button class="mc-btn blue" onclick="openSubject('matematica')" style="height:120px;"><div style="font-size:2rem; margin-bottom:10px;">üìê</div>Matem√°tica<br><br><small>Nivel <span id="lbl-math">1</span></small></button>
                <button class="mc-btn green" onclick="openSubject('compu')" style="height:120px;"><div style="font-size:2rem; margin-bottom:10px;">ü§ñ</div>Computaci√≥n<br><br><small>Nivel <span id="lbl-logic">1</span></small></button>
                <button class="mc-btn red" onclick="openSubject('teclado')" style="height:120px;"><div style="font-size:2rem; margin-bottom:10px;">‚å®Ô∏è</div>Teclado<br><br><small>Nivel <span id="lbl-typing">1</span></small></button>
                
                <button class="mc-btn purple" onclick="openSubject('ingles')" style="height:120px;"><div style="font-size:2rem; margin-bottom:10px;">üá∫üá∏</div>Ingles<br><br><small>Nivel <span id="lbl-ingles">1</span></small></button>
            </div>
        </div>
        <div id="view-map" style="display:none;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <h3 id="mapTitle" style="margin:0;">Juegos</h3>
                <button class="mc-btn gray" onclick="showDashboard()">‚Üê Volver</button>
            </div>
            <div class="level-grid" id="mapGrid"></div>
        </div>
        <div id="view-shop" style="display:none;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <h3 style="margin:0;">Tienda</h3>
                <button class="mc-btn gray" onclick="showDashboard()">‚Üê Salir</button>
            </div>
            <div class="subject-grid" id="shopGrid"></div>
        </div>
    </main>

    <aside>
        <div class="panel" style="padding:10px;">
            <h3 style="font-size:0.8rem; text-align:center; color:#f9a825;">üèÜ TOP 10</h3>
            <div class="leaderboard-list" id="leaderboardList"><div style="text-align:center; padding:20px;">Cargando...</div></div>
        </div>
    </aside>
</div>

<div class="overlay" id="gameModal" style="display:none;">
    <div class="modal-box">
        <h3 id="gameTitle" style="color:#0277bd;">Nivel 1</h3>
        <div id="gameContent" style="margin:30px 0;"></div>
        <button class="mc-btn red" onclick="closeGame()">Salir</button>
    </div>
</div>

<div class="overlay" id="adminLoginModal" style="display:none;">
    <div class="modal-box" style="width:400px;">
        <h3>Zona Developers</h3>
        <input type="text" id="adminUser" placeholder="Usuario (admin)">
        <input type="password" id="adminPass" placeholder="Contrase√±a (minecraft)">
        <div style="display:flex; gap:10px; margin-top:10px;">
            <button class="mc-btn green" style="flex:1;" onclick="checkAdmin()">Entrar</button>
            <button class="mc-btn gray" style="flex:1;" onclick="document.getElementById('adminLoginModal').style.display='none'">Cerrar</button>
        </div>
    </div>
</div>

<div class="overlay" id="adminPanelModal" style="display:none;">
    <div class="modal-box" style="width:700px; text-align:left;">
        <h3>üõ†Ô∏è crear objetos</h3>
        <div style="background:#eceff1; padding:15px; border:2px solid #b0bec5; margin-bottom:15px;">
            <h4 style="margin-top:0;">Nuevo Item / Textura</h4>
            <input type="text" id="admItemName" placeholder="Nombre">
            <input type="number" id="admPrice" placeholder="Precio">
            <select id="admType">
                <option value="head">Cabeza</option><option value="torso">Torso</option><option value="legs">Piernas</option><option value="arm">Brazos</option>
            </select>
            <input type="text" id="admTexture" placeholder="URL Imagen o Color Hex">
            <button class="mc-btn green" style="width:100%; margin-top:10px;" onclick="adminAddItem()">Crear Item</button>
        </div>
        
        <div style="background:#eceff1; padding:15px; border:2px solid #b0bec5;">
            <h4 style="margin-top:0;">Nuevo Nivel</h4>
            <select id="admSubj">
                <option value="matematica">Matem√°tica</option>
                <option value="compu">Computaci√≥n</option>
                <option value="teclado">Teclado</option>
                <option value="ingles">Ingles</option>
            </select>
            <select id="admGrade"><option value="1">Grado 1</option><option value="3">Grado 3</option><option value="5">Grado 5</option><option value="7">Grado 7</option></select>
            <input type="number" id="admLvlNum" placeholder="Nivel">
            <input type="text" id="admQ" placeholder="Pregunta">
            <input type="text" id="admAns" placeholder="Respuesta Correcta">
            <input type="text" id="admOpts" placeholder="Opciones (sep. coma)">
            <button class="mc-btn blue" style="width:100%; margin-top:10px;" onclick="adminAddLevel()">Guardar Nivel</button>
        </div>
        
        <button class="mc-btn gray" style="margin-top:20px; width:100%;" onclick="closeAdmin()">Cerrar Panel</button>
    </div>
</div>

<script>
    // 1. CONFIGURACI√ìN FIREBASE (TUS DATOS)
    const firebaseConfig = {
        apiKey: "AIzaSyD_EIqwof3YhStlpSY4PhWJLqoDtjUqsVM",
        authDomain: "web-de-juego.firebaseapp.com",
        projectId: "web-de-juego",
        storageBucket: "web-de-juego.firebasestorage.app",
        messagingSenderId: "251119316368",
        appId: "1:251119316368:web:a755c6deb4c4b476ce9715",
        measurementId: "G-C0QXJC0CWV"
    };

    firebase.initializeApp(firebaseConfig);
    const dbOnline = firebase.firestore();

    // 2. DATOS EDUCATIVOS
    const DB_CHARS = "ABCDEFGHIJKLMNOPQRSTUVWXYZ√ë";
    const DB_SIMPLE = ["SOL","PAN","LUZ","MAR","SAL","GATO","PERRO","CASA","AGUA","LUNA","ARBOL","MESA","SILLA","MANO","PIE"];
    const DB_SHORT = ["EL SOL SALE", "LA LUNA BRILLA", "EL GATO COME", "HOLA MUNDO", "BUENOS DIAS", "VAMOS A JUGAR"];
    const DB_DICT = ["ESCUELA", "AMIGO", "JUGUETE", "PARQUE", "CIUDAD", "VERANO", "INVIERNO", "MUSICA", "PINTURA"];
    const DB_COMPLEX = ["PROGRAMACION", "ALGORITMO", "VERG√úENZA", "TECNOLOGIA", "BIBLIOTECA", "NAVEGADOR", "VARIABLE"];
    const DB_LONG = ["LA INTELIGENCIA ARTIFICIAL CAMBIA EL MUNDO", "LOS ALGORITMOS RESUELVEN PROBLEMAS COMPLEJOS", "HTML Y CSS SON EL ESQUELETO DE LA WEB"];
    
    // BASE DE DATOS COMPUTACI√ìN
    const DB_COMPUTING = [
        {q:"¬øHardware?", ans:"Fisico", opts:["Fisico","Logico","Wifi"]},
        {q:"¬øSoftware?", ans:"Programas", opts:["Programas","Cables","Pantalla"]},
        {q:"Entrada", ans:"Teclado", opts:["Teclado","Monitor","Parlante"]},
        {q:"Salida", ans:"Monitor", opts:["Monitor","Mouse","Microfono"]},
        {q:"Cerebro PC", ans:"CPU", opts:["CPU","RAM","Disco"]},
        {q:"Binario es", ans:"0 y 1", opts:["0 y 1","1 a 10","A y B"]},
        {q:"Almacenar", ans:"Disco", opts:["Disco","Mouse","Pantalla"]},
        {q:"Internet", ans:"Red", opts:["Red","Juego","Programa"]}
    ];

    // BASE DE DATOS INGL√âS (NUEVA PARA EVITAR MEZCLAS)
    const DB_ENGLISH = [
        {q:"Red", ans:"Rojo", opts:["Rojo","Azul","Verde"]},
        {q:"Blue", ans:"Azul", opts:["Azul","Rojo","Amarillo"]},
        {q:"Dog", ans:"Perro", opts:["Perro","Gato","Pato"]},
        {q:"Cat", ans:"Gato", opts:["Gato","Perro","Vaca"]},
        {q:"Hello", ans:"Hola", opts:["Hola","Adios","Gracias"]},
        {q:"One", ans:"Uno", opts:["Uno","Dos","Tres"]},
        {q:"Family", ans:"Familia", opts:["Familia","Amigos","Casa"]},
        {q:"School", ans:"Escuela", opts:["Escuela","Parque","Cine"]}
    ];

    const DEFAULT_SHOP = [
        {id:'t1', name:'Camisa Steve', type:'torso', color:'#29b6f6', price:0},
        {id:'l1', name:'Pantal√≥n Azul', type:'legs', color:'#3f51b5', price:0},
        {id:'h1', name:'Piel Base', type:'head', color:'#ffcc80', price:0},
        {id:'t2', name:'Camisa Creeper', type:'torso', color:'https://i.imgur.com/u3l2j1S.png', price:100},
        {id:'h2', name:'Cara Zombie', type:'head', color:'#66bb6a', price:150},
        {id:'t3', name:'Oro Puro', type:'torso', color:'#fbc02d', price:200}
    ];

    let player = { 
        name: 'Jugador_' + Math.floor(Math.random()*999),
        grade: 1, coins: 50, 
        progress: { matematica: 1, compu: 1, teclado: 1, ingles: 1 }, 
        inventory: ['t1', 'l1', 'h1'], 
        skin: { head:'#ffcc80', torso:'#29b6f6', legs:'#3f51b5', arm:'#ffcc80' } 
    };
    let localDB = { customLevels: [], shopItems: DEFAULT_SHOP };
    let currentSession = { subject: null, level: 1, lastWord: '' };

    // 3. INICIO
    window.onload = function() {
        if(localStorage.getItem('eduPlayer')) player = JSON.parse(localStorage.getItem('eduPlayer'));
        if(localStorage.getItem('eduDB')) localDB = JSON.parse(localStorage.getItem('eduDB'));
        
        document.getElementById('usernameInput').value = player.name;
        
        // Asegurar que exista la propiedad ingles si es un jugador viejo
        if(!player.progress.ingles) player.progress.ingles = 1;

        updateUI();
        syncWithCloud();
    };

    function saveData() {
        localStorage.setItem('eduPlayer', JSON.stringify(player));
        localStorage.setItem('eduDB', JSON.stringify(localDB));
        syncWithCloud();
    }

    function syncWithCloud() {
        dbOnline.collection("players").doc(player.name).set(player)
        .then(() => loadLeaderboard())
        .catch(e => console.error(e));
    }

    function loadLeaderboard() {
        dbOnline.collection("players").orderBy("coins", "desc").limit(10).onSnapshot(snapshot => {
            const list = document.getElementById('leaderboardList');
            list.innerHTML = '';
            let rank = 1;
            snapshot.forEach(doc => {
                const p = doc.data();
                const row = document.createElement('div');
                row.className = `leaderboard-row ${rank===1?'top-1':''}`;
                const getStyle = (val) => val && val.startsWith('http') ? `background-image:url('${val}'); background-size:cover;` : `background:${val};`;
                
                row.innerHTML = `
                    <div class="rank">#${rank++}</div>
                    <div class="mini-avatar-box">
                        <div class="mc-head mc-part" style="${getStyle(p.skin.head || '#ffcc80')} width:40px; height:40px;"></div>
                        <div style="display:flex; gap:2px;">
                            <div style="width:12px; height:20px; border:2px solid #000; ${getStyle(p.skin.arm || p.skin.torso)}"></div>
                            <div style="width:40px; height:20px; border:2px solid #000; ${getStyle(p.skin.torso)}"></div>
                            <div style="width:12px; height:20px; border:2px solid #000; ${getStyle(p.skin.arm || p.skin.torso)}"></div>
                        </div>
                    </div>
                    <div style="flex:1; display:flex; justify-content:space-between;">
                        <div style="font-weight:bold; color:#37474f;">${p.name}</div>
                        <div style="color:#f9a825;">${p.coins}</div>
                    </div>`;
                list.appendChild(row);
            });
        });
    }

    // 4. L√ìGICA DE JUEGO
    function playLevel(lvl) {
        currentSession.level = lvl;
        document.getElementById('gameModal').style.display = 'flex';
        const content = document.getElementById('gameContent');
        document.getElementById('gameTitle').innerText = `Nivel ${lvl}`;
        
        const custom = localDB.customLevels.find(l => l.grade == player.grade && l.subject === currentSession.subject && l.level == lvl);
        if(custom) renderQuestion(content, custom.question, custom.answer, custom.options);
        else generateLevel(content, currentSession.subject, lvl);
    }

    function generateLevel(container, subj, lvl) {
        let q, ans, opts;

        // --- TYPING ---
        if (subj === 'teclado') {
            let target = "", prompt = "", showStats = false;
            
            if (player.grade <= 3) {
                if(lvl <= 20) { target = DB_CHARS[Math.floor(Math.random()*DB_CHARS.length)]; prompt = "Tecla:"; }
                else if(lvl <= 40) { target = DB_SIMPLE[Math.floor(Math.random()*DB_SIMPLE.length)]; prompt = "Palabra:"; }
                else { target = DB_SHORT[Math.floor(Math.random()*DB_SHORT.length)]; prompt = "Oraci√≥n:"; }
            } else {
                if(lvl <= 10) { target = DB_DICT[Math.floor(Math.random()*DB_DICT.length)]; prompt = "Escribe:"; }
                else if(lvl <= 30) { target = DB_COMPLEX[Math.floor(Math.random()*DB_COMPLEX.length)]; prompt = "Escribe:"; }
                else { target = DB_LONG[Math.floor(Math.random()*DB_LONG.length)]; prompt = "Transcribe:"; showStats=true; }
            }
            
            ans = target;
            container.innerHTML = `
                ${showStats ? `<div class="stats-bar"><div class="stats-item">Palabras: <span id="wCounter">0</span></div></div>` : ''}
                <div style="color:#78909c; font-size:0.8rem; margin-bottom:10px;">${prompt}</div>
                <h3 style="color:#555; font-size:${ans.length>20?'0.8rem':'1.5rem'}">${ans}</h3>
                <input type="text" id="typingInput" autocomplete="off" style="text-align:center; text-transform:uppercase; font-size:1.2rem; width:100%;">
                <button class="mc-btn green" style="width:100%; margin-top:15px;" onclick="checkAnswer(document.getElementById('typingInput').value, '${ans}')">Confirmar</button>
            `;
            setTimeout(() => { 
                const i = document.getElementById('typingInput'); 
                if(i) { i.focus(); i.onkeydown = (e) => { if(e.key==='Enter') checkAnswer(i.value, ans); };
                if(showStats) i.oninput = () => { document.getElementById('wCounter').innerText = i.value.trim().split(/\s+/).filter(x=>x).length; }; }
            }, 50);
            return;
        }

        // --- SEPARACI√ìN DE TEMAS ---
        if (subj === 'compu') {
            const item = DB_COMPUTING[Math.floor(Math.random()*DB_COMPUTING.length)];
            q = item.q; ans = item.ans; opts = item.opts.sort(()=>Math.random()-0.5);
        }
        else if (subj === 'ingles') {
            const item = DB_ENGLISH[Math.floor(Math.random()*DB_ENGLISH.length)];
            q = item.q; ans = item.ans; opts = item.opts.sort(()=>Math.random()-0.5);
        }
        else { // matematica
            const max = (player.grade * 10) + (lvl * 5);
            const a = Math.floor(Math.random()*max), b = Math.floor(Math.random()*max);
            q = `¬ø${a} + ${b}?`; ans = a+b; opts = [ans, ans+1, ans-1, ans+5].sort(()=>Math.random()-0.5);
        }

        let html = `<h2 style="color:#455a64; margin-bottom:30px;">${q}</h2><div style="display:grid; grid-template-columns:1fr 1fr; gap:15px;">`;
        opts.forEach(opt => { html += `<button class="mc-btn blue" onclick="checkAnswer('${opt}','${ans}')">${opt}</button>`; });
        html += `</div>`;
        container.innerHTML = html;
    }

    function checkAnswer(user, correct) {
        if (String(user).toUpperCase().trim() === String(correct).toUpperCase().trim()) {
            player.coins += 20;
            if(currentSession.level === player.progress[currentSession.subject]) player.progress[currentSession.subject]++;
            saveData(); updateUI(); showToast("¬°Correcto! +20 ü™ô");
            setTimeout(() => { if(currentSession.level < 50) playLevel(currentSession.level + 1); else closeGame(); }, 800);
        } else {
            player.coins = Math.max(0, player.coins - 10);
            saveData(); updateUI(); showToast("Incorrecto -10 ü™ô", 'error');
        }
    }

    // 5. UTILS Y RENDERIZADO
    function applyTexture(elementId, value) {
        const el = document.getElementById(elementId);
        if(!el) return;
        if(value && (value.startsWith('http') || value.startsWith('data:image'))) {
            el.style.backgroundColor = 'transparent';
            el.style.backgroundImage = `url('${value}')`;
        } else {
            el.style.backgroundImage = 'none';
            el.style.backgroundColor = value;
        }
    }

    function updateUI() {
        document.getElementById('uiCoins').innerText = player.coins;
        document.getElementById('lbl-math').innerText = player.progress.matematica;
        document.getElementById('lbl-logic').innerText = player.progress.compu;
        document.getElementById('lbl-typing').innerText = player.progress.teclado;
        document.getElementById('lbl-ingles').innerText = player.progress.ingles;
        
        applyTexture('avHead', player.skin.head || '#ffcc80');
        applyTexture('avTorso', player.skin.torso);
        applyTexture('avLegL', player.skin.legs);
        applyTexture('avLegR', player.skin.legs);
        applyTexture('avArmL', player.skin.arm || player.skin.torso);
        applyTexture('avArmR', player.skin.arm || player.skin.torso);
    }

    function updateUsername(val) { player.name = val; saveData(); }
    function changeGrade() { player.grade = parseInt(document.getElementById('gradeSelect').value); showToast(`Grado ${player.grade}`); }
    function showToast(msg, type='success') {
        const t = document.createElement('div'); t.className = `toast ${type}`;
        t.innerHTML = `<span>${type=='success'?'‚úÖ':'‚ùå'}</span><span>${msg}</span>`;
        document.getElementById('notification-area').appendChild(t); setTimeout(() => t.remove(), 4000);
    }
    function resetGame() { if(confirm("¬øBorrar todo?")) { localStorage.removeItem('eduPlayer'); location.reload(); } }
    
    function showDashboard() { setView('view-dashboard'); }
    function showShop() { setView('view-shop'); renderShop(); }
    function openSubject(s) { currentSession.subject = s; setView('view-map'); document.getElementById('mapTitle').innerText = s.toUpperCase(); renderMap(); }
    function setView(id) { ['view-dashboard','view-map','view-shop'].forEach(v => document.getElementById(v).style.display = 'none'); document.getElementById(id).style.display = 'block'; }
    function closeGame() { document.getElementById('gameModal').style.display = 'none'; renderMap(); }

    function renderMap() {
        const grid = document.getElementById('mapGrid'); grid.innerHTML = '';
        const cur = player.progress[currentSession.subject];
        for(let i=1; i<=50; i++) {
            const btn = document.createElement('div'); btn.className = 'level-block'; btn.innerText = i;
            if(i<cur) { btn.classList.add('completed'); btn.onclick = () => playLevel(i); }
            else if(i===cur) { btn.classList.add('current'); btn.onclick = () => playLevel(i); }
            else btn.classList.add('locked');
            grid.appendChild(btn);
        }
    }

    function renderShop() {
        const g = document.getElementById('shopGrid'); g.innerHTML = '';
        localDB.shopItems.forEach(it => {
            const owned = player.inventory.includes(it.id);
            const d = document.createElement('div'); d.className = 'panel'; d.style.textAlign='center';
            
            let bgStyle = it.color.startsWith('http') ? `background-image:url('${it.color}'); background-size:cover;` : `background:${it.color};`;
            
            d.innerHTML = `<div style="width:40px;height:40px;${bgStyle} margin:0 auto 10px;border:2px solid #000;"></div>
                           <b>${it.name}</b><br><span style="font-size:0.6rem; color:#666">${it.type}</span><br>
                           <small>${owned?'Tuyo':it.price}</small>`;
            d.onclick = () => {
                if(owned) { player.skin[it.type] = it.color; saveData(); updateUI(); showToast("Equipado"); }
                else if(player.coins >= it.price) { player.coins -= it.price; player.inventory.push(it.id); player.skin[it.type] = it.color; saveData(); updateUI(); renderShop(); showToast("Comprado"); }
                else showToast("Faltan Monedas", 'error');
            };
            g.appendChild(d);
        });
    }

    // ADMIN
    function openAdminLogin() { document.getElementById('adminLoginModal').style.display = 'flex'; }
    function checkAdmin() { 
        if(document.getElementById('adminUser').value==='admin' && document.getElementById('adminPass').value==='minecraft') {
            document.getElementById('adminLoginModal').style.display='none'; document.getElementById('adminPanelModal').style.display='flex';
        } else showToast("Error", 'error');
    }
    function closeAdmin() { document.getElementById('adminPanelModal').style.display='none'; renderShop(); }
    
    function adminAddLevel() {
        const g=document.getElementById('admGrade').value, s=document.getElementById('admSubj').value, l=document.getElementById('admLvlNum').value;
        const q=document.getElementById('admQ').value, a=document.getElementById('admAns').value, o=document.getElementById('admOpts').value;
        if(!l||!q||!a) return showToast("Faltan Datos",'error');
        localDB.customLevels.push({ grade: parseInt(g), subject: s, level: parseInt(l), question: q, answer: a, options: o });
        saveData(); showToast("Nivel Guardado");
    }
    
    function adminAddItem() {
        const n=document.getElementById('admItemName').value, p=document.getElementById('admPrice').value, t=document.getElementById('admType').value, c=document.getElementById('admTexture').value;
        if(!n || !c) return showToast("Falta Info",'error');
        localDB.shopItems.push({ id: 'c_'+Date.now(), name: n, price: parseInt(p), type: t, color: c });
        saveData(); showToast("Item Creado");
    }
</script>

</body>

</html>

