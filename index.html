<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Web de juegos para ni√±os</title>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

    <style>
        /* ESTILOS (Id√©nticos) */
        :root { 
            --sky: #e0f7fa; 
            --cloud: #ffffff; 
            --text: #37474f; 
            --btn-green: #66bb6a; 
            --btn-blue: #42a5f5; 
            --btn-purple: #ab47bc; 
            --btn-red: #ef5350; 
            --stone: #90a4ae;
            --gold: #ffd700; 
            ----btn-pink: #e368e7;}
        * { box-sizing: border-box; }
        body { font-family: 'Press Start 2P', cursive; background-color: var(--sky); background-image: radial-gradient(#b2ebf2 15%, transparent 16%), radial-gradient(#b2ebf2 15%, transparent 16%); background-size: 30px 30px; color: var(--text); margin: 0; padding: 20px; user-select: none; line-height: 1.5; }
        .app-container { max-width: 1400px; margin: 0 auto; display: grid; grid-template-columns: 280px 1fr 320px; gap: 20px; }
        header { grid-column: 1 / -1; display: flex; justify-content: space-between; align-items: center; }
        .panel { background: var(--cloud); border: 4px solid #37474f; padding: 20px; margin-bottom: 20px; box-shadow: 6px 6px 0px rgba(0,0,0,0.1); }
        .mc-btn { color: #fff; border: 4px solid; padding: 15px; font-family: 'Press Start 2P', cursive; font-size: 0.7rem; cursor: pointer; text-transform: uppercase; box-shadow: inset -4px -4px 0px 0px rgba(0,0,0,0.2); position: relative; transition: transform 0.1s; }
        .mc-btn:active { transform: translateY(4px); box-shadow: inset -2px -2px 0px 0px rgba(0,0,0,0.2); }
        .mc-btn.green { background-color: var(--btn-green); border-color: #2e7d32; } 
        .mc-btn.blue { background-color: var(--btn-blue); border-color: #1565c0; } 
        .mc-btn.purple { background-color: var(--btn-purple); border-color: #7b1fa2; } 
        .mc-btn.red { background-color: var(--btn-red); border-color: #c62828; } 
        .mc-btn.gray { background-color: var(--stone); border-color: #546e7a; }
        .mc-btn.pink { background-color: var(----btn-pink); border-color: #e368e7; }

        .avatar-container { display: flex; flex-direction: column; align-items: center; gap: 2px; transform: scale(1.8); margin: 40px 0; }
        .mc-part { border: 2px solid #000; background-size: cover !important; background-position: center !important; image-rendering: pixelated; position: relative; }
        .mc-head { width: 40px; height: 40px; background: #ffcc80; z-index: 5; }
        .mc-eyes { display: flex; gap: 14px; position: absolute; top: 15px; left: 6px; pointer-events: none; }
        .eye { width: 6px; height: 6px; background: white; border: 1px solid black; } .pupil { width: 3px; height: 3px; background: black; margin-left: 2px; margin-top: 1px; }
        .mc-body-row { display: flex; gap: 2px; z-index: 4; } .mc-arm { width: 12px; height: 40px; background: #ffcc80; margin-top: 0; } .mc-torso { width: 40px; height: 40px; background: #29b6f6; }
        .mc-legs-row { display: flex; gap: 2px; z-index: 3; } .mc-leg { width: 18px; height: 40px; background: #3f51b5; }
        .leaderboard-list { display: flex; flex-direction: column; gap: 10px; max-height: 600px; overflow-y: auto; }
        .leaderboard-row { display: flex; align-items: center; gap: 10px; background: #eceff1; padding: 8px; border: 2px solid #b0bec5; font-size: 0.6rem; }
        .leaderboard-row.top-1 { border-color: var(--gold); background: #fffde7; }
        .mini-avatar-box { transform: scale(0.5); width: 45px; height: 70px; margin: -20px -5px; } 
        .subject-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; }
        .level-grid { display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; }
        .level-block { width: 45px; height: 45px; background: #cfd8dc; border: 4px solid #90a4ae; display: flex; align-items: center; justify-content: center; cursor: pointer; color: #546e7a; font-weight: bold; font-size: 0.8rem; }
        .level-block.locked { opacity: 0.5; cursor: not-allowed; background: #eceff1; }
        .level-block.completed { background: var(--btn-green); border-color: #2e7d32; color: white; }
        .level-block.current { background: white; border-color: var(--btn-blue); color: var(--btn-blue); transform: scale(1.1); box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        input, select { padding: 12px; margin: 5px 0; width: 100%; font-family: 'Press Start 2P'; border: 2px solid #90a4ae; background: #eceff1; color: #37474f; outline: none; }
        .stats-bar { display: flex; justify-content: space-around; background: #263238; color: #4caf50; padding: 10px; border: 2px solid #000; margin-bottom: 15px; font-size: 0.7rem; }
        .stats-item span { color: #ffeb3b; }
        .stat-danger { color: #ef5350 !important; }
        #notification-area { position: fixed; top: 20px; right: 20px; z-index: 2000; display: flex; flex-direction: column; gap: 10px; }
        .toast { background: #333; color: #fff; padding: 15px 20px; border: 4px solid #fff; font-size: 0.7rem; display: flex; align-items: center; gap: 10px; box-shadow: 4px 4px 0px rgba(0,0,0,0.2); animation: slideIn 0.3s forwards, fadeOut 0.5s 3s forwards; min-width: 250px; }
        .toast.success { background: var(--btn-green); border-color: #1b5e20; } .toast.error { background: var(--btn-red); border-color: #b71c1c; }
        .overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); backdrop-filter: blur(4px); z-index: 100; justify-content: center; align-items: center; }
        .modal-box { background: var(--cloud); padding: 20px; border: 4px solid #37474f; width: 95%; max-width: 700px; text-align: center; box-shadow: 0 10px 20px rgba(0,0,0,0.2); }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes fadeOut { to { opacity: 0; pointer-events: none; } }
        .admin-tag { font-size: 0.6rem; color: #90a4ae; margin-top: 15px; cursor: pointer; text-decoration: underline; }
    </style>
</head>
<body>

<div id="notification-area"></div>

<div class="app-container">
    <header class="panel">
        <div><h1 style="margin:0; color:#0277bd; font-size:1.5rem;">Web de juegos</h1></div>
        <div style="text-align:right">
            <div style="color:#fbc02d; font-size:1.2rem; margin-bottom:5px;">ü™ô <span id="uiCoins">0</span></div>
            <select id="gradeSelect" onchange="changeGrade()" style="width:auto; font-size:0.6rem; padding:5px;">
                <option value="inicial">Nivel: Inicial</option>
                <option value="intermedia">Nivel: Intermedia</option>
                <option value="dificil">Nivel: Dif√≠cil</option>
                <option value="experta">Nivel: Experta</option>
                <option value="prodigio">Nivel: üåü Prodigio</option>
            </select>
        </div>  
    </header>

    <aside>
        <div class="panel" style="text-align:center;">
            <h3 style="font-size:0.8rem;">Nombre</h3>
            <input type="text" id="usernameInput" placeholder="Nombre" maxlength="10" style="text-align:center; margin-bottom:15px; font-size:0.7rem;" onchange="updateUsername(this.value)">
            <div class="avatar-container">
                <div class="mc-head mc-part" id="avHead"><div class="mc-eyes" id="defaultEyes"><div class="eye"><div class="pupil"></div></div><div class="eye"><div class="pupil"></div></div></div></div>
                <div class="mc-body-row"><div class="mc-arm mc-part" id="avArmL"></div><div class="mc-torso mc-part" id="avTorso"></div><div class="mc-arm" id="avArmR"></div></div>
                <div class="mc-legs-row"><div class="mc-leg" id="avLegL"></div><div class="mc-leg" id="avLegR"></div></div>
            </div>
            <div style="display:flex; flex-direction:column; gap:10px; margin-top:20px;">
                <button class="mc-btn blue" onclick="showDashboard()"> üéÆJUEGOS</button>
                <button class="mc-btn green" onclick="showShop()">üõçÔ∏è Tienda<br><br> (en DESARROLLO) </button>
            </div>
            <div style="margin-top: 30px; border-top: 2px dashed #90a4ae; padding-top: 10px;">
                <div class="admin-tag" onclick="openAdminLogin()">Administrador</div>
                <button class="mc-btn red" style="width:100%; margin-top:15px; font-size:0.6rem;" onclick="resetGame()">‚ö†Ô∏è Reiniciar</button>
            </div>
        </div>
    </aside>

    <main class="panel">
        <div id="view-dashboard">
            <h3 style="margin-top:0;">Selecciona Modo</h3>
            <div class="subject-grid">

                <button class="mc-btn blue" onclick="openSubject('matematica')" style="height:120px;">
                    <div style="font-size:2rem; margin-bottom:10px;">üìê</div>
                    Matem√°tica<br><br>
                    <small>Nivel <span id="lbl-math">1</span></small>
                </button>

                <button class="mc-btn green" onclick="openSubject('compu')" style="height:120px;">
                    <div style="font-size:2rem; margin-bottom:10px;">ü§ñ</div>
                    Computaci√≥n<br><br>(en DESARROLLO)<br><br>
                    <small>Nivel <span id="lbl-logic">1</span></small>
                </button>

                <button class="mc-btn red" onclick="openSubject('teclado')" style="height:120px;">
                    <div style="font-size:2rem; margin-bottom:10px;">‚å®Ô∏è</div>
                    Teclado<br><br>
                    <small>Nivel <span id="lbl-typing">1</span></small>
                </button>

                <button class="mc-btn purple" onclick="openSubject('ingles')" style="height:120px;">
                    <div style="font-size:2rem; margin-bottom:10px;">üá∫üá∏</div>
                    Ingles <br><br>(en DESARROLLO)<br><br>
                    <small>Nivel <span id="lbl-ingles">1</span></small>
                </button>

                <button class="mc-btn pink" onclick="openSubject('produccion')" style="height:120px;">
                    <div style="font-size:2rem; margin-bottom:10px;">‚ö†Ô∏è</div>
                    En produccion<br><br>
                    <small>Nivel <span id="lbl-produc">1</span></small>
                </button>

            </div>
        </div>
        <div id="view-map" style="display:none;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <h3 id="mapTitle" style="margin:0;">Juegos</h3>
                <button class="mc-btn gray" onclick="showDashboard()">‚Üê Volver</button>
            </div>
            <div class="level-grid" id="mapGrid"></div>
        </div>
        <div id="view-shop" style="display:none;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <h3 style="margin:0;">Tienda</h3>
                <button class="mc-btn gray" onclick="showDashboard()">‚Üê Salir</button>
            </div>
            <div class="subject-grid" id="shopGrid"></div>
        </div>
    </main>

    <aside>
        <div class="panel" style="padding:10px;">
            <h3 style="font-size:0.8rem; text-align:center; color:#f9a825;">üèÜ TOP 10</h3>
            <div class="leaderboard-list" id="leaderboardList"><div style="text-align:center; padding:20px;">
                formando...
            </div></div>
        </div>
    </aside>
</div>

<div class="overlay" id="gameModal" style="display:none;">
    <div class="modal-box">
        <h3 id="gameTitle" style="color:#0277bd;">Nivel 1</h3>
        <div id="gameContent" style="margin:30px 0;"></div>
        <button class="mc-btn red" onclick="closeGame()">Salir</button>
    </div>
</div>

<div class="overlay" id="adminLoginModal" style="display:none;">
    <div class="modal-box" style="width:400px;">
        <h3>Zona Developers</h3>
        <input type="text" id="adminUser" placeholder="Usuario">
        <input type="password" id="adminPass" placeholder="Contrase√±a">
        <div style="display:flex; gap:10px; margin-top:10px;">
            <button class="mc-btn green" style="flex:1;" onclick="checkAdmin()">Entrar</button>
            <button class="mc-btn gray" style="flex:1;" onclick="document.getElementById('adminLoginModal').style.display='none'">Cerrar</button>
        </div>
    </div>
</div>

<div class="overlay" id="adminPanelModal" style="display:none;">
    <div class="modal-box" style="width:700px; text-align:left;">
        <h3>üõ†Ô∏è Panel Creador</h3>
        <div style="background:#eceff1; padding:15px; border:2px solid #b0bec5; margin-bottom:15px;">
            <h4 style="margin-top:0;">Nuevo Item / Textura</h4>
            <input type="text" id="admItemName" placeholder="Nombre">
            <input type="number" id="admPrice" placeholder="Precio">
            
            <select id="admType">
                <option value="head">Cabeza</option>
                <option value="torso">Torso</option>
                <option value="legs">Piernas</option>
                <option value="arm">Brazos</option>
            </select>
            
            <input type="text" id="admTexture" placeholder="URL Imagen o C√≥digo Hex">
            <button class="mc-btn green" style="width:100%; margin-top:10px;" onclick="adminAddItem()">Crear Item</button>
        </div>
        <div style="background:#eceff1; padding:15px; border:2px solid #b0bec5;">
            <h4 style="margin-top:0;">Nuevo Nivel</h4>
            <select id="admSubj">
                <option value="matematica">Matem√°tica</option>
                <option value="compu">Computaci√≥n</option>
                <option value="ingles">Ingles</option>
                <option value="teclado">Teclado</option>
                <option value="produccion">En Producci√≥n</option>
            </select>
            <select id="admGrade">
                <option value="inicial">Inicial</option>
                <option value="intermedia">Intermedia</option>
                <option value="dificil">Dif√≠cil</option>
                <option value="experta">Experta</option>
                <option value="prodigio">Prodigio</option>
            </select> 
            <input type="number" id="admLvlNum" placeholder="Nivel (1-60)">
            <input type="text" id="admQ" placeholder="Pregunta / Texto Typing">
            <input type="text" id="admAns" placeholder="Respuesta Correcta">
            <input type="text" id="admOpts" placeholder="Opciones (sep. coma)">
            <button class="mc-btn blue" style="width:100%; margin-top:10px;" onclick="adminAddLevel()">Guardar Nivel</button>
        </div>
        <button class="mc-btn gray" style="margin-top:20px; width:100%;" onclick="closeAdmin()">Cerrar Panel</button>
    </div>
</div>

<script>
    // 1. CONFIGURACI√ìN FIREBASE
    const firebaseConfig = {
        apiKey: "AIzaSyD_EIqwof3YhStlpSY4PhWJLqoDtjUqsVM",
        authDomain: "web-de-juego.firebaseapp.com",
        projectId: "web-de-juego",
        storageBucket: "web-de-juego.firebasestorage.app",
        messagingSenderId: "251119316368",
        appId: "1:251119316368:web:a755c6deb4c4b476ce9715",
        measurementId: "G-C0QXJC0CWV"
    };

    firebase.initializeApp(firebaseConfig);
    const dbOnline = firebase.firestore();

    // =======================================================
    // 2. BASE DE DATOS TECLADO EXTENSA Y PROGRESIVA
    // =======================================================
    
    const DB_TECLADO = {
        // NIVEL INICIAL (Aprendizaje de teclas)
        inicial: {
            // Nivel 1-25: Teclas sueltas
            letras: "ASDFJKL√ëQWERTYUIOPZXCVBNM".split(''), 
            // Nivel 26-40: S√≠mbolos F√°ciles
            simbolos: [".", ",", ";", ":", "-", "_", "!", "?", "¬ø", "¬°", "+", "="], //ACA SEGUI AGREGANDO
            // Nivel 41-60: Palabras F√°ciles
            palabras: [
                "SOL", 
                "LUZ", 
                "PAN", 
                "MAR", 
                "OSO", 
                "MAMA", 
                "PAPA", 
                "GATO", 
                "PERRO", 
                "MESA", 
                "SILLA", 
                "CASA", 
                "AUTO", 
                "TREN", 
                "FLOR", 
                "RIO", 
                "LAGO", 
                "MANO", 
                "PIE", 
                "DEDO"
                //ACA SEGUI AGREGANDO
            ] 
        },
        
        // NIVEL INTERMEDIO (Introducci√≥n a acentos y puntuaci√≥n)
        intermedia: {
            // Nivel 1-20: Palabras medias (sin tilde)
            palabras: [
                "ESCUELA", 
                "AMIGO", 
                "JUGUETE", 
                "PARQUE", 
                "CIUDAD", 
                "VERANO",
                "INVIERNO", 
                "MUSICA", 
                "PINTURA", 
                "COMIDA", 
                "TIENDA"
                //ACA SEGUI AGREGANDO
            ],
            // Nivel 21-40: Palabras con tilde y signos
            tildes: [
                "√ÅRBOL", 
                "CANT√ì", 
                "AVI√ìN", 
                "NI√ëO", 
                "FELIZ", 
                "L√ÅPIZ", 
                "RAT√ìN", 
                "BOT√ìN", 
                "CAF√â", 
                "PAP√Å", 
                "JARD√çN", 
                "M√öSICA", 
                "R√ÅPIDO"
            //ACA SEGUI AGREGANDO
            ],
            // Nivel 41-60: Oraciones cortas
            oraciones: [
                "EL PERRO LADRA.", 
                "ME GUSTA EL SOL.", 
                "HOY ES LUNES.", 
                "¬øCOMO ESTAS?", 
                "HOLA MUNDO.", 
                "TENGO HAMBRE.", 
                "VAMOS AL CINE."
                  //ACA SEGUI AGREGANDO  
            ]
        },

        // NIVEL DIFICIL (Palabras complejas y simbolos raros)
        dificil: {
            // Nivel 1-20: Palabras largas/complejas
            palabras: [
                "ELECTRODOMESTICO", 
                "FERROCARRIL", 
                "CONSTITUCION", 
                "PARALELEPIPEDO", 
                "DESOXIRRIBONUCLEICO", 
                "CALIDOSCOPIO", 
                "ESTERNOCLEIDOMASTOIDEO",
                "HIPOPOTAMO",
                "ORNITORRINCO",
                "ANTICONSTITUCIONALIDAD",
                "INCONSTITUCIONALIDAD",
                "SUPERCALIFRAGILISTICOESPIALIDOSO",
                "PROCESADOR",
                "TELECOMUNICACIONES"
                //ACA SEGUI AGREGANDO
            ],
            // Nivel 21-40: S√≠mbolos COMPLEJOS (Chaos Mode)
            simbolos: ["@", "#", "$", "%", "&", "/", "(", ")", "{", "}", "[", "]", "\\", "|", "¬∞", "¬¨", "~", "^", "`", "*"],
            // Nivel 41-60: C√≥digo simple
            codigo: ["width:100%", "#FFAA00", "user_name", "email@gmail.com", "http://web.com", "$dinero", "print('Hola')", "x = y + 2", "<div>TEXTO</div>"]
        },

        // NIVEL EXPERTA (Oraciones largas)
        experta: {
            // Todo oraciones complejas
            oraciones: [
                "LA TECNOLOGIA AVANZA EXPONENCIALMENTE CADA A√ëO.",
                "LOS ALGORITMOS DE BUSQUEDA SON FUNDAMENTALES.",
                "LA INTELIGENCIA ARTIFICIAL GENERATIVA CREA ARTE.",
                "EL DESARROLLO DE SOFTWARE REQUIERE LOGICA.",
                "LA CIBERSEGURIDAD PROTEGE LOS DATOS PRIVADOS.",
                "LAS REDES NEURONALES IMITAN EL CEREBRO HUMANO.",
                "PROGRAMAR ES UNA HABILIDAD VALIOSA HOY DIA.",
                "PROGRAMAR ES CREAR",
                "EL FUTURO ES DIGITAL Y CONECTADO",
                "LA INNOVACION IMPULSA EL CAMBIO TECNOLOGICO",
                "HAY QUE APRENDER SOBRE SEGURIDAD DIGITAL"
                //ACA SEGUI AGREGANDO
            ]
        },

        // NIVEL PRODIGIO (TEXTOS LARGOS CON MAY√öSCULAS Y MIN√öSCULAS)
        prodigio: {
            textos: [
                "En un lugar de la Mancha, de cuyo nombre no quiero acordarme.",
                "Programar es el arte de decirle a otro humano lo que la PC debe hacer.",
                "El √©xito no es definitivo, el fracaso no es fatal: lo que cuenta es el coraje.",
                "La imaginaci√≥n es m√°s importante que el conocimiento.",
                "No he fallado, simplemente he encontrado mil maneras que no funcionan.",
                "La vida es como andar en bicicleta: para mantener el equilibrio debes seguir adelante.",
                "La educaci√≥n es el arma m√°s poderosa que puedes usar para cambiar el mundo.",
                "La tecnolog√≠a es solo una herramienta.",
                "En t√©rminos de motivar a los ni√±os y hacer que trabajen juntos, el profesor es lo m√°s importante.",
                "El aprendizaje nunca agota la mente.",
                "La educaci√≥n STEAM integra ciencia, tecnolog√≠a, ingenier√≠a, arte y matem√°ticas para formar creadores integrales.",
                "yo aprendo a programar con los profes te Tecno Kids",
                "la perseverancia es la clave del exito en la vida",
                "LAS PLATAFORMAS DE APRENDIZAJE EN L√çNEA ELIMINAN LAS BARRERAS GEOGR√ÅFICAS Y DEMOCRATIZAN EL ACCESO A LA INFORMACI√ìN GLOBAL"
                //ACA SEGUI AGREGANDO
            ]
        }
    };

    // OTROS DATOS
    const DB_COMPUTING = [
        {q:"¬øHardware?", 
            ans:"Fisico", //respuesta correcta
            opts:[
                "Fisico",
                "Logico",
                "Wifi"
            ]
        }, 
        {q:"¬øSoftware?", 
            ans:"Programas", //respuesta correcta
            opts:[
                "Programas",
                "Cables",
                "Pantalla"
            ]
        },
        {q:"Entrada", 
            ans:"Teclado", //respuesta correcta
            opts:[
                "Teclado",
                "Monitor",
                "Parlante"
            ]
        }, 
        {q:"Salida", 
            ans:"Monitor", //respuesta correcta
            opts:[
                "Monitor",
                "Mouse",
                "Microfono"
            ]
        }, 
        {q:"Cerebro PC", 
            ans:"CPU", //respuesta correcta
            opts:[
                "CPU",
                "RAM",
                "Disco"
            ]
        }
        //ACA SEGUI AGREGANDO
    ];
    const DB_INGLES = [
        {q:"Red", 
            ans:"Rojo", 
            opts:[
                "Rojo",
                "Azul",
                "Verde"
            ]
        }, 
        {q:"Blue", 
            ans:"Azul", 
            opts:[
                "Azul",
                "Rojo",
                "Amarillo"
            ]
        }, 
        {q:"Dog", 
            ans:"Perro", 
            opts:[
                "Perro",
                "Gato",
                "Pato"
            ]
        }, 
        {q:"Cat", 
            ans:"Gato", 
            opts:[
                "Gato",
                "Perro",
                "Vaca"
            ]
        }
        //ACA SEGUI AGREGANDO
    ];

    const DEFAULT_SHOP = [
        {id:'t1', name:'Camisa Steve', type:'torso', color:'#29b6f6', price:0},
        {id:'l1', name:'Pantal√≥n Azul', type:'legs', color:'#3f51b5', price:0},
        {id:'h1', name:'Piel Base', type:'head', color:'#ffcc80', price:0},
        {id:'t2', name:'Camisa Creeper', type:'torso', color:'https://i.imgur.com/u3l2j1S.png', price:100},
        {id:'h2', name:'Cara Zombie', type:'head', color:'#66bb6a', price:150},
        {id:'t3', name:'Oro Puro', type:'torso', color:'#fbc02d', price:200},
    ];

    let player = { 
        name: 'Jugador_' + Math.floor(Math.random()*999),
        grade: 'inicial', 
        coins: 50, 
        progress: {
            inicial: { matematica: 1, compu: 1, teclado: 1, ingles: 1 },
            intermedia: { matematica: 1, compu: 1, teclado: 1, ingles: 1 },
            dificil: { matematica: 1, compu: 1, teclado: 1, ingles: 1 },
            experta: { matematica: 1, compu: 1, teclado: 1, ingles: 1 },
            prodigio: { matematica: 1, compu: 1, teclado: 1, ingles: 1 }
        },
        inventory: ['t1', 'l1', 'h1'], 
        skin: { head:'#ffcc80', torso:'#29b6f6', legs:'#3f51b5', arm:'#ffcc80' } 
    };
    let localDB = { customLevels: [], shopItems: DEFAULT_SHOP };
    let currentSession = { subject: null, level: 1, lastWord: '', startTime: null, backspaces: 0 };
    let timerInterval = null; 

    // 3. INICIO
    window.onload = function() {
        if(localStorage.getItem('eduPlayer')) {
            let saved = JSON.parse(localStorage.getItem('eduPlayer'));
            if(saved.grade === 1 || saved.grade === 7) { 
                console.log("Reiniciando estructura...");
            } else {
                player = saved;
            }
        }
        if(localStorage.getItem('eduDB')) localDB = JSON.parse(localStorage.getItem('eduDB'));
        
        document.getElementById('usernameInput').value = player.name;
        document.getElementById('gradeSelect').value = player.grade;
        updateUI();
        syncWithCloud();
    };

    function saveData() {
        localStorage.setItem('eduPlayer', JSON.stringify(player));
        localStorage.setItem('eduDB', JSON.stringify(localDB));
        syncWithCloud();
    }

    function syncWithCloud() {
        dbOnline.collection("players").doc(player.name).set(player)
        .then(() => loadLeaderboard())
        .catch(e => console.error(e));
    }

    function loadLeaderboard() {
        dbOnline.collection("players").orderBy("coins", "desc").limit(10).onSnapshot(snapshot => {
            const list = document.getElementById('leaderboardList');
            list.innerHTML = '';
            let rank = 1;
            snapshot.forEach(doc => {
                const p = doc.data();
                const row = document.createElement('div');
                row.className = `leaderboard-row ${rank===1?'top-1':''}`;
                const getStyle = (val) => val && val.startsWith('http') ? `background-image:url('${val}'); background-size:cover;` : `background:${val};`;
                
                row.innerHTML = `
                    <div class="rank">#${rank++}</div>
                    <div class="mini-avatar-box">
                        <div class="mc-head mc-part" style="${getStyle(p.skin.head || '#ffcc80')} width:40px; height:40px;"></div>
                        <div style="display:flex; gap:2px;">
                            <div style="width:12px; height:20px; border:2px solid #000; ${getStyle(p.skin.arm || p.skin.torso)}"></div>
                            <div style="width:40px; height:20px; border:2px solid #000; ${getStyle(p.skin.torso)}"></div>
                            <div style="width:12px; height:20px; border:2px solid #000; ${getStyle(p.skin.arm || p.skin.torso)}"></div>
                        </div>
                    </div>
                    <div style="flex:1; display:flex; justify-content:space-between;">
                        <div style="font-weight:bold; color:#37474f;">${p.name}</div>
                        <div style="color:#f9a825;">${p.coins}</div>
                    </div>`;
                list.appendChild(row);
            });
        });
    }

    // 4. L√ìGICA DE JUEGO
    function playLevel(lvl) {
        currentSession.level = lvl;
        currentSession.startTime = null; 
        currentSession.backspaces = 0;   
        if(timerInterval) clearInterval(timerInterval);
        
        document.getElementById('gameModal').style.display = 'flex';
        const content = document.getElementById('gameContent');
        document.getElementById('gameTitle').innerText = `Nivel ${lvl} (${player.grade.toUpperCase()})`;
        
        const custom = localDB.customLevels.find(l => l.grade == player.grade && l.subject === currentSession.subject && l.level == lvl);
        if(custom) {
            renderQuestion(content, custom.question, custom.answer, custom.options);
        } else {
            generateProceduralLevel(content, currentSession.subject, lvl);
        }
    }

    function generateProceduralLevel(container, subj, lvl) {
        let q, ans, opts;

        // --- TECLADO ---
        if (subj === 'teclado') {
            let target = "", prompt = "", showStats = false;
            let pool = DB_TECLADO[player.grade]; 
            // Modo Prodigio: Case Sensitive
            let isProdigio = player.grade === 'prodigio';

            if(isProdigio) showStats = true;

            // 1. INICIAL
            if (player.grade === 'inicial') {
                if(lvl <= 25) { target = getRandom(pool.letras); prompt = "Tecla:"; }
                else if(lvl <= 40) { target = getRandom(pool.simbolos); prompt = "S√≠mbolo:"; }
                else { target = getRandom(pool.palabras); prompt = "Palabra:"; }
            }
            // 2. INTERMEDIA
            else if (player.grade === 'intermedia') {
                if(lvl <= 20) { target = getRandom(pool.palabras); prompt = "Palabra:"; }
                else if(lvl <= 40) { target = getRandom(pool.tildes); prompt = "Con Tilde:"; }
                else { target = getRandom(pool.oraciones); prompt = "Oraci√≥n:"; }
            }
            // 3. DIFICIL
            else if (player.grade === 'dificil') {
                if(lvl <= 20) { target = getRandom(pool.palabras); prompt = "Palabra Larga:"; }
                else if(lvl <= 40) { target = getRandom(pool.simbolos); prompt = "S√≠mbolos Caos:"; }
                else { target = getRandom(pool.codigo); prompt = "C√≥digo:"; }
            }
            // 4. EXPERTA
            else if (player.grade === 'experta') {
                target = getRandom(pool.oraciones); prompt = "Transcribe:";
            }
            // 5. PRODIGIO
            else if (player.grade === 'prodigio') {
                target = getRandom(pool.textos); prompt = "Transcribe (Contrarreloj):";
            }
            
            if(!target) target = "HOLA"; 
            ans = target;

            // Estilo del Input: Uppercase autom√°tico solo si NO es prodigio
            let inputStyle = "text-align:center; font-size:1.2rem; width:100%;";
            if (!isProdigio) inputStyle += " text-transform:uppercase;";

            container.innerHTML = `
                ${showStats ? `
                <div class="stats-bar">
                    <div class="stats-item">‚è≥ <span id="timeCounter">0.0s</span></div>
                    <div class="stats-item">‚å®Ô∏è <span id="delCounter" class="stat-danger">0</span></div>
                    <div class="stats-item">üìù <span id="wCounter">0</span></div>
                </div>` : ''}
                
                <div style="color:#78909c; font-size:0.8rem; margin-bottom:10px;">${prompt}</div>
                <h3 style="color:#555; font-size:${ans.length>25?'0.7rem':'1.2rem'}">${ans}</h3>
                
                <input type="text" id="typingInput" autocomplete="off" style="${inputStyle}">
                <button class="mc-btn green" style="width:100%; margin-top:15px;" onclick="checkAnswer(document.getElementById('typingInput').value, '${ans}')">Confirmar</button>
            `;
            
            setTimeout(() => { 
                const i = document.getElementById('typingInput'); 
                if(i) { 
                    i.focus(); 
                    
                    // L√≥gica del Timer: Solo arranca al escribir
                    i.oninput = () => { 
                        if(!currentSession.startTime && showStats) {
                            currentSession.startTime = new Date();
                            timerInterval = setInterval(() => {
                                let now = new Date();
                                document.getElementById('timeCounter').innerText = ((now - currentSession.startTime)/1000).toFixed(1) + 's';
                            }, 100);
                        }
                        if(showStats) document.getElementById('wCounter').innerText = i.value.trim().split(/\s+/).filter(x=>x).length; 
                    };

                    i.onkeydown = (e) => { 
                        if(showStats && e.key === 'Backspace') {
                            currentSession.backspaces++;
                            document.getElementById('delCounter').innerText = currentSession.backspaces;
                        }
                        if(e.key === 'Enter') checkAnswer(i.value, ans); 
                    };
                }
            }, 50);
            return;
        }

        // --- OTRAS MATERIAS ---
        if (subj === 'compu') {
            const item = getRandom(DB_COMPUTING);
            q = item.q; ans = item.ans; opts = item.opts.sort(()=>Math.random()-0.5);
        }
        else if (subj === 'ingles') {
            const item = getRandom(DB_INGLES); 
            q = item.q; ans = item.ans; opts = item.opts.sort(()=>Math.random()-0.5);
        }
        else { //matematica
            let a, b, opSelector;
            let range = 10; // Rango base por defecto

            // 1. NIVEL INICIAL (Grados 1-2 aprox)
            if (player.grade === 'inicial') {
                opSelector = Math.random();
                if (opSelector < 0.4) { // Suma (1-20)
                    a = Math.floor(Math.random() * 20) + 1;
                    b = Math.floor(Math.random() * 10) + 1;
                    q = `¬ø${a} + ${b}?`; ans = a + b;
                } else if (opSelector < 0.7) { // Resta (Simple, sin negativos)
                    a = Math.floor(Math.random() * 15) + 5;
                    b = Math.floor(Math.random() * (a - 1)) + 1;
                    q = `¬ø${a} - ${b}?`; ans = a - b;
                } else if (opSelector < 0.9) { // Multiplicaci√≥n (Muy b√°sica 1-5)
                    a = Math.floor(Math.random() * 5) + 1;
                    b = Math.floor(Math.random() * 3) + 1;
                    q = `¬ø${a} x ${b}?`; ans = a * b;
                } else { // Divisi√≥n (B√°sica: mitad, tercio)
                    b = Math.floor(Math.random() * 2) + 2; // Divisor 2 o 3
                    ans = Math.floor(Math.random() * 5) + 1;
                    a = b * ans; // Asegurar divisi√≥n exacta
                    q = `¬ø${a} / ${b}?`;
                }
            } 
            
            // 2. NIVEL INTERMEDIA (Grados 3-4 aprox)
            else if (player.grade === 'intermedia') {
                opSelector = Math.random();
                if (opSelector < 0.3) { // Suma (Hasta 100)
                    a = Math.floor(Math.random() * 80) + 10;
                    b = Math.floor(Math.random() * 50) + 10;
                    q = `¬ø${a} + ${b}?`; ans = a + b;
                } else if (opSelector < 0.6) { // Resta
                    a = Math.floor(Math.random() * 90) + 10;
                    b = Math.floor(Math.random() * (a - 5)) + 1;
                    q = `¬ø${a} - ${b}?`; ans = a - b;
                } else if (opSelector < 0.8) { // Multiplicaci√≥n (Tablas 1-9)
                    a = Math.floor(Math.random() * 9) + 2;
                    b = Math.floor(Math.random() * 9) + 2;
                    q = `¬ø${a} x ${b}?`; ans = a * b;
                } else { // Divisi√≥n (Tablas exactas)
                    b = Math.floor(Math.random() * 5) + 2; // Divisor 2-6
                    ans = Math.floor(Math.random() * 9) + 2;
                    a = b * ans;
                    q = `¬ø${a} / ${b}?`;
                }
            }

            // 3. NIVEL DIFICIL (Grados 5-6 aprox)
            else if (player.grade === 'dificil') {
                opSelector = Math.random();
                if (opSelector < 0.3) { // Suma (Centenas)
                    a = Math.floor(Math.random() * 400) + 100;
                    b = Math.floor(Math.random() * 400) + 100;
                    q = `¬ø${a} + ${b}?`; ans = a + b;
                } else if (opSelector < 0.6) { // Resta (Centenas)
                    a = Math.floor(Math.random() * 800) + 100;
                    b = Math.floor(Math.random() * (a - 50));
                    q = `¬ø${a} - ${b}?`; ans = a - b;
                } else if (opSelector < 0.8) { // Multiplicaci√≥n (2 cifras x 1 cifra)
                    a = Math.floor(Math.random() * 15) + 10; // 10-25
                    b = Math.floor(Math.random() * 8) + 2;   // 2-9
                    q = `¬ø${a} x ${b}?`; ans = a * b;
                } else { // Divisi√≥n
                    b = Math.floor(Math.random() * 8) + 2;
                    ans = Math.floor(Math.random() * 20) + 5;
                    a = b * ans;
                    q = `¬ø${a} / ${b}?`;
                }
            }

            // 4. NIVEL EXPERTA (Grado 7)
            else if (player.grade === 'experta') {
                opSelector = Math.random();
                if (opSelector < 0.25) { // Suma (Miles)
                    a = Math.floor(Math.random() * 2000) + 500;
                    b = Math.floor(Math.random() * 2000) + 500;
                    q = `¬ø${a} + ${b}?`; ans = a + b;
                } else if (opSelector < 0.5) { // Resta
                    a = Math.floor(Math.random() * 3000) + 1000;
                    b = Math.floor(Math.random() * (a - 100));
                    q = `¬ø${a} - ${b}?`; ans = a - b;
                } else if (opSelector < 0.75) { // Multiplicaci√≥n (Compleja)
                    a = Math.floor(Math.random() * 50) + 10;
                    b = Math.floor(Math.random() * 9) + 2;
                    q = `¬ø${a} x ${b}?`; ans = a * b;
                } else { // Divisi√≥n
                    b = Math.floor(Math.random() * 9) + 3;
                    ans = Math.floor(Math.random() * 50) + 10;
                    a = b * ans;
                    q = `¬ø${a} / ${b}?`;
                }
            }

            // 5. NIVEL PRODIGIO (Desaf√≠o Total)
            else if (player.grade === 'prodigio') {
                opSelector = Math.random();
                if (opSelector < 0.25) { // Suma Gigante
                    a = Math.floor(Math.random() * 9000) + 1000;
                    b = Math.floor(Math.random() * 9000) + 1000;
                    q = `¬ø${a} + ${b}?`; ans = a + b;
                } else if (opSelector < 0.5) { // Resta Gigante
                    a = Math.floor(Math.random() * 10000) + 5000;
                    b = Math.floor(Math.random() * 4000) + 1000;
                    q = `¬ø${a} - ${b}?`; ans = a - b;
                } else if (opSelector < 0.75) { // Multiplicaci√≥n (2 cifras x 2 cifras)
                    a = Math.floor(Math.random() * 20) + 10; // 10-30
                    b = Math.floor(Math.random() * 20) + 10; // 10-30
                    q = `¬ø${a} x ${b}?`; ans = a * b;
                } else { // Divisi√≥n (N√∫meros grandes)
                    b = Math.floor(Math.random() * 15) + 5; // Divisor 5-20
                    ans = Math.floor(Math.random() * 30) + 10;
                    a = b * ans;
                    q = `¬ø${a} / ${b}?`;
                }
            }

            // Generar opciones incorrectas inteligentes (cercanas al resultado)
            opts = [
                ans,
                ans + Math.floor(Math.random() * 5) + 1,
                ans - Math.floor(Math.random() * 5) - 1,
                ans + 10
            ].sort(() => Math.random() - 0.5);
        }
        let html = `<h2 style="color:#455a64; margin-bottom:30px;">${q}</h2><div style="display:grid; grid-template-columns:1fr 1fr; gap:15px;">`;
        opts.forEach(opt => { html += `<button class="mc-btn blue" onclick="checkAnswer('${opt}','${ans}')">${opt}</button>`; });
        html += `</div>`;
        container.innerHTML = html;
    }

    function checkAnswer(user, correct) {
        let isCorrect = false;
        
        // Validaci√≥n Prodigio: Case Sensitive
        if (player.grade === 'prodigio' && currentSession.subject === 'teclado') {
            // Comparaci√≥n estricta
            if (String(user).trim() === String(correct).trim()) {
                isCorrect = true;
            }
        } else {
            // Comparaci√≥n normal (May√∫sculas ignoradas)
            if (String(user).toUpperCase().trim() === String(correct).toUpperCase().trim()) {
                isCorrect = true;
            }
        }

        if (isCorrect) {
            player.coins += 20;
            // ACTUALIZAR PROGRESO DEL GRADO ACTUAL
            if(currentSession.level === player.progress[player.grade][currentSession.subject]) {
                player.progress[player.grade][currentSession.subject]++;
            }
            saveData(); updateUI(); showToast("¬°Correcto! +20 ü™ô");
            
            if(timerInterval) clearInterval(timerInterval); // Parar timer

            setTimeout(() => { if(currentSession.level < 60) playLevel(currentSession.level + 1); else closeGame(); }, 800);
        } else {
            player.coins = Math.max(0, player.coins - 10);
            saveData(); updateUI(); showToast("Incorrecto -10 ü™ô", 'error');
        }
    }

    function getRandom(arr) { if(!arr || arr.length===0) return "X"; return arr[Math.floor(Math.random() * arr.length)]; }

    function applyTexture(elementId, value) {
        const el = document.getElementById(elementId);
        if(!el) return;
        if(value && (value.startsWith('http') || value.startsWith('data:image'))) {
            el.style.backgroundColor = 'transparent'; el.style.backgroundImage = `url('${value}')`;
        } else {
            el.style.backgroundImage = 'none'; el.style.backgroundColor = value;
        }
    }

    function updateUI() {
        document.getElementById('uiCoins').innerText = player.coins;
        const p = player.progress[player.grade];
        document.getElementById('lbl-math').innerText = p.matematica;
        document.getElementById('lbl-logic').innerText = p.compu;
        document.getElementById('lbl-typing').innerText = p.teclado;
        document.getElementById('lbl-ingles').innerText = p.ingles;
        
        applyTexture('avHead', player.skin.head || '#ffcc80');
        applyTexture('avTorso', player.skin.torso);
        applyTexture('avLegL', player.skin.legs);
        applyTexture('avLegR', player.skin.legs);
        applyTexture('avArmL', player.skin.arm || player.skin.torso);
        applyTexture('avArmR', player.skin.arm || player.skin.torso);
    }

    function updateUsername(val) { player.name = val; saveData(); }
    function changeGrade() { 
        player.grade = document.getElementById('gradeSelect').value; 
        updateUI(); 
        showToast(`Dificultad: ${player.grade.toUpperCase()}`); 
    }
    function showToast(msg, type='success') {
        const t = document.createElement('div'); t.className = `toast ${type}`;
        t.innerHTML = `<span>${type=='success'?'‚úÖ':'‚ùå'}</span><span>${msg}</span>`;
        document.getElementById('notification-area').appendChild(t); setTimeout(() => t.remove(), 4000);
    }
    function resetGame() { if(confirm("¬øBorrar todo?")) { localStorage.removeItem('eduPlayer'); location.reload(); } }
    
    function showDashboard() { setView('view-dashboard'); }
    function showShop() { setView('view-shop'); renderShop(); }
    function openSubject(s) { currentSession.subject = s; setView('view-map'); document.getElementById('mapTitle').innerText = s.toUpperCase(); renderMap(); }
    function setView(id) { ['view-dashboard','view-map','view-shop'].forEach(v => document.getElementById(v).style.display = 'none'); document.getElementById(id).style.display = 'block'; }
    function closeGame() { document.getElementById('gameModal').style.display = 'none'; if(timerInterval) clearInterval(timerInterval); renderMap(); }

    function renderMap() {
        const grid = document.getElementById('mapGrid'); grid.innerHTML = '';
        const cur = player.progress[player.grade][currentSession.subject];
        for(let i=1; i<=60; i++) {
            const btn = document.createElement('div'); btn.className = 'level-block'; btn.innerText = i;
            if(i<cur) { btn.classList.add('completed'); btn.onclick = () => playLevel(i); }
            else if(i===cur) { btn.classList.add('current'); btn.onclick = () => playLevel(i); }
            else btn.classList.add('locked');
            grid.appendChild(btn);
        }
    }

    function renderShop() {
        const g = document.getElementById('shopGrid'); g.innerHTML = '';
        localDB.shopItems.forEach(it => {
            const owned = player.inventory.includes(it.id);
            const d = document.createElement('div'); 
            d.className = 'panel'; 
            d.style.textAlign='center';
            let bgStyle = it.color.startsWith('http') ? `background-image:url('${it.color}'); background-size:cover;` : `background:${it.color};`;
            d.innerHTML = `<div style="width:40px;height:40px;${bgStyle} margin:0 auto 10px;border:2px solid #000;"></div><b>${it.name}</b><br><span style="font-size:0.6rem; color:#666">${it.type}</span><br><small>${owned?'Tuyo':it.price}</small>`;
            d.onclick = () => {
                if(owned) { 
                    player.skin[it.type] = it.color; 
                    saveData(); 
                    updateUI(); 
                    showToast("Equipado"); 
                }
                else if(player.coins >= it.price) { 
                    player.coins -= it.price; player.inventory.push(it.id); 
                    player.skin[it.type] = it.color; 
                    saveData(); 
                    updateUI(); 
                    renderShop(); 
                    showToast("Comprado"); 
                }
                else showToast("Faltan Monedas", 'error');
            };
            g.appendChild(d);
        });
    }

    // ADMIN
    function openAdminLogin() { document.getElementById('adminLoginModal').style.display = 'flex'; }
    function checkAdmin() { 
        if(document.getElementById('adminUser').value==='admin' && document.getElementById('adminPass').value==='minecraft') {
            document.getElementById('adminLoginModal').style.display='none'; document.getElementById('adminPanelModal').style.display='flex';
        } else showToast("Error", 'error');
    }
    function closeAdmin() { document.getElementById('adminPanelModal').style.display='none'; renderShop(); }
    
    function adminAddLevel() {
        const g=document.getElementById('admGrade').value, s=document.getElementById('admSubj').value, l=document.getElementById('admLvlNum').value;
        const q=document.getElementById('admQ').value, a=document.getElementById('admAns').value, o=document.getElementById('admOpts').value;
        if(!l||!q||!a) return showToast("Faltan Datos",'error');
        localDB.customLevels.push({ grade: g, subject: s, level: parseInt(l), question: q, answer: a, options: o });
        saveData(); showToast("Nivel Guardado");
    }
    
    function adminAddItem() {
        const n=document.getElementById('admItemName').value, p=document.getElementById('admPrice').value, t=document.getElementById('admType').value, c=document.getElementById('admTexture').value;
        if(!n || !c) return showToast("Falta Info",'error');
        localDB.shopItems.push({ id: 'c_'+Date.now(), name: n, price: parseInt(p), type: t, color: c });
        saveData(); showToast("Item Creado");
    }





    
</script>

</body>

</html>

